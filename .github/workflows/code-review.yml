name: Code Review with LLM

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Debug - List all changed files
      run: |
        echo "üìã Listing all changed files..."
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} || true
        echo ""
        echo "üìä File count:"
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l || true
    
    - name: Debug - Check file types
      run: |
        echo "üîç Checking file extensions..."
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | while read file; do
          if [ -n "$file" ]; then
            extension="${file##*.}"
            echo "$file -> .$extension"
          fi
        done || true
    
    - name: Generate code review
      id: review
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LLM_API_URL: ${{ secrets.LLM_API_URL || 'http://127.0.0.1:8000/api/review/' }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        BASE_SHA: ${{ github.event.pull_request.base.sha }}
        HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      run: |
        echo "üìä Starting code review process..."
        echo "üîó API URL: ${LLM_API_URL}"
        python .github/scripts/code_review.py
    
    - name: Print review results
      if: always()
      env:
        # ƒê∆∞a n·ªôi dung v√†o bi·∫øn m√¥i tr∆∞·ªùng ƒë·ªÉ tr√°nh l·ªói c√∫ ph√°p Bash
        REVIEW_CONTENT: ${{ steps.review.outputs.review_content }}
        HAS_REVIEW: ${{ steps.review.outputs.has_review }}
      run: |
        echo ""
        echo "üìã ====== REVIEW RESULTS ======"
        echo ""
        
        if [[ "$HAS_REVIEW" == "true" ]]; then
          # S·ª≠ d·ª•ng printf ho·∫∑c echo v·ªõi bi·∫øn m√¥i tr∆∞·ªùng gi√∫p x·ª≠ l√Ω k√Ω t·ª± ƒë·∫∑c bi·ªát an to√†n
          echo "$REVIEW_CONTENT" | sed 's/%0A/\n/g' | sed 's/%0D/\r/g'
        else
          echo "No review was generated."
          echo "Review output: $REVIEW_CONTENT"
        fi
        
        echo ""
        echo "=============================="
    
    # - name: Post review as comment
    #   if: steps.review.outputs.has_review == 'true'
    #   uses: actions/github-script@v6
    #   with:
    #     script: |
    #       // Decode the review content
    #       const reviewContent = `## ü§ñ AI Code Review\n\n${{ steps.review.outputs.review_content }}`;
          
    #       console.log("Posting review comment...");
    #       console.log("Review length:", reviewContent.length);
          
    #       try {
    #         // X√≥a comment c≈© n·∫øu c√≥ (c·ªßa bot)
    #         const { data: comments } = await github.rest.issues.listComments({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           issue_number: context.issue.number
    #         });
            
    #         const botComments = comments.filter(comment => 
    #           comment.body.includes('ü§ñ AI Code Review') || 
    #           comment.user.login === 'github-actions[bot]'
    #         );
            
    #         console.log(`Found ${botComments.length} old bot comments to delete`);
            
    #         for (const comment of botComments) {
    #           try {
    #             await github.rest.issues.deleteComment({
    #               owner: context.repo.owner,
    #               repo: context.repo.repo,
    #               comment_id: comment.id
    #             });
    #             console.log(`Deleted comment ${comment.id}`);
    #           } catch (error) {
    #             console.log(`Error deleting comment ${comment.id}:`, error.message);
    #           }
    #         }
            
    #         // T·∫°o comment m·ªõi
    #         const newComment = await github.rest.issues.createComment({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           issue_number: context.issue.number,
    #           body: reviewContent
    #         });
            
    #         console.log(`‚úÖ Posted new comment with ID: ${newComment.data.id}`);
            
    #       } catch (error) {
    #         console.error("‚ùå Error posting comment:", error);
    #         throw error;
    #       }